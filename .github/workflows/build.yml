name: Build Windows EXE

permissions:
  contents: write

on:
  push:
    branches: ["main"]

jobs:
  build:
    runs-on: windows-latest

    steps:

    # -----------------------------
    # CHECKOUT CODE
    # -----------------------------
    - name: Checkout Code
      uses: actions/checkout@v3

    # -----------------------------
    # PYTHON
    # -----------------------------
    - name: Install Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"

    - name: Install Dependencies
      run: |
        pip install -r requirements.txt
        pip install pyinstaller

    # -----------------------------
    # DOWNLOAD yt-dlp
    # -----------------------------
    - name: Download yt-dlp.exe
      run: |
        mkdir ytdlp
        curl -L https://github.com/yt-dlp/yt-dlp/releases/latest/download/yt-dlp.exe -o ytdlp/yt-dlp.exe

    # -----------------------------
    # DOWNLOAD + EXTRACT FFMPEG
    # -----------------------------
    - name: Download FFmpeg
      shell: pwsh
      run: |
        curl -L https://www.gyan.dev/ffmpeg/builds/ffmpeg-release-essentials.zip -o ffmpeg.zip

        # Extract to temp folder
        Expand-Archive ffmpeg.zip -DestinationPath ffmpeg_temp

        # Create final ffmpeg directory
        mkdir ffmpeg

        # Find the extracted folder (dynamic!)
        $folder = Get-ChildItem ffmpeg_temp | Where-Object { $_.PSIsContainer } | Select-Object -First 1

        # Copy the bin folder
        Copy-Item "$($folder.FullName)\bin\*" "ffmpeg" -Recurse -Force

        # Cleanup
        Remove-Item ffmpeg_temp -Recurse -Force
        Remove-Item ffmpeg.zip -Force

    # -----------------------------
    # BUILD EXE
    # -----------------------------
    - name: Build EXE
      run: |
        cd app
        pyinstaller --noconsole --onefile --windowed ^
          --add-binary "../ffmpeg/ffmpeg.exe;ffmpeg" ^
          --add-binary "../ffmpeg/ffprobe.exe;ffmpeg" ^
          --add-binary "../ytdlp/yt-dlp.exe;ytdlp" ^
          --add-data "resources;resources" ^
          --icon "resources/icon.ico" ^
          youtube_downloader.py

    # -----------------------------
    # RELEASE
    # -----------------------------
    - name: Upload EXE to Release
      uses: softprops/action-gh-release@v1
      with:
        files: app/dist/youtube_downloader.exe
        tag_name: "v${{ github.run_number }}"
        name: "YouTube Downloader v${{ github.run_number }}"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
